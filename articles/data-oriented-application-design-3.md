---
title: "データ指向アプリケーションデザイン 3章 まとめ"
emoji: "🎄"
type: "tech"
topics: ["列指向", "Bツリー", "LSMツリー", "memo"]
published: true
---

# はじめに
データ指向アプリケーションデザインを読んでいるので自分の理解のためにメモをまとめます。  
概要では全体に書いてあること、詳細では概要のそれぞれの要素についてを書きます。

# 概要
2章ではアプリケーションの開発者の側からデータベースを利用する際にどういう形式でデータを保存するか、取り出すかをデータモデル、クエリの種類や特徴を通して整理しました。  
3章ではデータベースがデータを保存、取り出す際に内部でストレージエンジンがどのように動作をするか、どういう形式でデータを保存、取り出すのかを整理します。  
まず大きくはトランザクション処理システム、分析処理システムのどちらの用途でデータベースを使用するかで内部の動作が異なります。  
トランザクション処理システムは特定の時間内に処理するリクエストは多いですが、1度のリクエストで処理するレコード数は少ないという特性のためストレージエンジンがインデックスを用いて高速にデータを取り出す必要があります。  
これはトランザクション処理システムの場合はディスク上でデータのある場所を探すシークがボトルネックになりやすいということです。  
分析処理システムは特定の時間内に処理するリクエストは少ないですが、1度のリクエストで処理するレコード数は多いという特性のためストレージエンジンが列指向でデータをコンパクトにエンコードしデータを大量に取り出す必要があります。  
これは分析処理システムの場合はディスクからデータを移動するための帯域がボトルネックになりやすいということです。  
トランザクション処理システムの場合にストレージエンジンが使用するデータの保存形式は代表的なものだとLSMツリー、Bツリーの2種類があります。  
これらもそれぞれ特徴が異なり、書き込みに優れているのはLSMツリー、読み込みに優れているのはBツリーとなっています。
分析計の場合にストレージエンジンが使用するデータの保存形式は列指向ストレージが使用されていることが多いです。


# 詳細
- LSMツリー  
LSMツリーとはキーバリュー形式のデータをメモリに保存し、メモリ上のデータが大きくなったら、SSTableファイルとしてディスクに保存します。  
そして、SSTableファイルが大きくなった場合には古い値、使われていない値を削除時ファイルのマージとコンパクションを行うような構造です。  
データの保存方法は同じキーに対して、古い値を新しい値に置き換えるのではなく追記をしていく方式となっています。  
そのため検索時にはまずメモリ内のツリーを検索し、メモリに無ければSSTableファイルを新しい方から順に見ていきます。  
マージ、コンパクションはバックグラウンドで行われており、SSTableファイル内のデータで使われていないもの、新しく上書きされたものを削除して複数のファイルをまとめていきます。  
LSMツリーの特徴としてはキーがソート順に保存されているので、範囲検索が早いことと、ディスクへの書き込みはシーケンシャルになるため高い書き込みのスループットを出すことができます。
また範囲検索には早いですが、Bツリーと比較するとバックグラウンドでコンパクション処理が動くため実行中の読み書きのパーフォマンスに影響がある場合があります。  


- Bツリー  
Bツリーは最も広く使われているインデックス構造であり、キーバリュー形式でキーをソートした状態でデータを保存します。  
データの保存時には同じキーに対して古い値を新しい値に置き換える方式となっています。  
Bツリーはデータベースを固定サイズのページに分割し、ページごとにデータを読み書きします。  
各ページは他のページへの参照を持つことができ、すべてキーはソートされているためどのデータがどこにあるかを、最初のページから順番にたどっていくことができます。   
Bツリーの特徴としてはLSMツリーに比べて、各ページが他のページへ参照することができるため検索に優れています。ただ逆にデータの保存時には複数のページをまたいで保存する必要性が出てくるため書き込みはLSMツリーの方が優れています。  
また依存関係のある複数の値をまとめて置き換える場合に、データがクラッシュすると参照されないデータが出てしまうためwrite-aheadログとDBに対する呼ばれるBツリーに対する変更内容を保存する別の構造化データを使用するなどが必要です。


- トランザクション処理システムと分析処理システム  
それぞれ用途、特性が異なります。

  - トランザクション処理システム  
  一般的なアプリケーションでWebアプリケーションを利用するエンドユーザー、顧客の入力に基づいて、データのルックアップ、保存、更新が行われるシステムです。  
  扱うデータは分析処理システムと比較すると小さく、1回のクエリでの読み込み、書き込みは分析処理システムよりも低レイテンシで行われます。
  データの時間軸としては主にデータの最新状態が利用されます。
  - 分析処理システム
  主に組織内のアナリストが経営判断を支援するためにデータを分析するシステムです。  
  扱うデータはトランザクション処理システムと比較すると大きく、1回のクエリでの読み込み、書き込みはトランザクション処理システムよりも時間がかかります。
  データの時間軸としては主にデータの時間経過とともに生じた出来事の履歴が利用されます。
  

- 列指向ストレージ  
列指向ストレージは主にデータウェアハウス、分析処理システムで使用されています。   
分析処理システムでは読み込む行数は多いですが、1度のクエリで使用する列数は少ないことが多いです。  
このため行ごとではなく、列ごとにデータを保存する形式を列指向ストレージといいます。  
列ごとに値を保存することの利点は他にもあります。同じ列では似たような値が多くなるためデータの圧縮が行いやすいというものです。
