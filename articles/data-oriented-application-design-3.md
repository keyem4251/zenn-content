---
title: "データ指向アプリケーションデザイン 3章 まとめ"
emoji: "🎩"
type: "tech"
topics: ["列思考", "インデックス", "LSMツリー", "memo"]
published: false
---

# はじめに
データ指向アプリケーションデザインを読んでいるので自分の理解のためにメモをまとめます。  
概要では全体に書いてあること、詳細では概要のそれぞれの要素についてを書きます。

# 概要
2章ではアプリケーションの開発者の側からデータベースを利用する際にどういう形式でデータを保存するか、取り出すかをデータモデル、クエリの種類や特徴を通して整理しました。  
3章ではデータベースがデータを保存、取り出す際に内部でストレージエンジンがどのように動作をするか、どういう形式でデータを保存、取り出すのかを整理します。  
まず大きくはトランザクション系、分析系のどちらの用途でデータベースを使用するかで内部の動作が異なります。  
トランザクション系は特定の時間内に処理するリクエストは多いですが、1度のリクエストで処理するレコード数は少ないという特性のためストレージエンジンがインデックスを用いて高速にデータを取り出す必要があります。  
これはトランザクション系の場合はディスク上でデータのある場所を探すシークがボトルネックになりやすいということです。  
分析計は特定の時間内に処理するリクエストは少ないですが、1度のリクエストで処理するレコード数は多いという特性のためストレージエンジンが列志向でデータをコンパクトにエンコードしデータを大量に取り出す必要があります。  
これは分析計の場合はディスクからデータを移動するための帯域がボトルネックになりやすいということです。  
トランザクション系の場合にストレージエンジンが使用するデータの保存形式は、log-structured、Bツリーの2種類があります。  
ToDo log-structured、Bツリーの得意なことを書く  
分析計の場合にストレージエンジンが使用するデータの保存形式は列志向となっています。


# 詳細
- LSMツリー  
LSMツリーとはキーバリュー形式のデータをメモリに保存し、メモリ上のデータが大きくなったら、SSTableファイルとしてディスクに保存します。  
そして、SSTableファイルが大きくなった場合には古い値、使われていない値を削除時ファイルのマージとコンパクションを行うような構造です。  
データの保存方法は同じキーに対して、古い値を新しい値に置き換えるのではなく追記をしていく方式となっています。  
そのため検索時にはまずメモリ内のツリーを検索し、メモリに無ければSSTableファイルを新しい方から順に見ていきます。  
マージ、コンパクションはバックグラウンドで行われており、SSTableファイル内のデータで使われていないもの、新しく上書きされたものを削除して複数のファイルをまとめていきます。  
LSMツリーの特徴としてはキーがソート順に保存されているので、範囲検索が早いことと、ディスクへの書き込みはシーケンシャルになるため高い書き込みのスループットを出すことができます。
また範囲検索には早いですが、Bツリーと比較するとバックグラウンドでコンパクション処理が動くため実行中の読み書きのパーフォマンスに影響がある場合があります。  


- Bツリー  
Bツリーは最も広く使われているインデックス構造であり、キーバリュー形式でキーをソートした状態でデータを保存します。  
データの保存時には同じキーに対して古い値を新しい値に置き換える方式となっています。  
Bツリーはデータベースを固定サイズのページに分割し、ページごとにデータを読み書きします。  
各ページは他のページへの参照を持つことができ、すべてキーはソートされているためどのデータがどこにあるかを、最初のページから順番にたどっていくことができます。   
Bツリーの特徴としてはLSMツリーに比べて、各ページが他のページへ参照することができるため検索に優れています。ただ逆にデータの保存時には複数のページをまたいで保存する必要性が出てくるため書き込みはLSMツリーの方が優れています。  
また依存関係のある複数の値をまとめて置き換える場合に、データがクラッシュすると参照されないデータが出てしまうためwrite-aheadログとDBに対する呼ばれるBツリーに対する変更内容を保存する別の構造化データを使用するなどが必要です。


- トランザクション or 分析処理
- 列志向ストレージ
