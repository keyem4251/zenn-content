---
title: "データ指向アプリケーションデザイン 2部 5章 まとめ"
emoji: "🏄‍♂️"
type: "idea"
topics: ["レプリケーション", "リーダー", "フォロワー", "memo"]
published: false
---
# はじめに
データ指向アプリケーションデザインを読んでいるので自分の理解のためにメモをまとめます。  
概要では全体に書いてあること、詳細では概要のそれぞれの要素についてを書きます。  
2部は5〜9章まであり、複数のノードにデータを分散させる手法のレプリケーション(5章)、パーティショニング(6章)についての説明、7章ではトランザクション、8、9章では分散システムの制約について記載します。

# 概要
ユーザの近くにデータを保持する、可用性を高めるなどのために、ネットワークに接続された複数のマシンにデータのコピーを保持することをレプリケーションといいます。  
複数のマシンにデータをコピーすることにより、ユーザーの近くにデータを配置することによるレイテンシ、分散し保存することによる可用性、複数のクライアントからの読み取りに対処できるスループットなどのメリットがあります。  
その反面、複数のマシンがあるためのデータの一貫性という観点でデータの変更の取り扱いが難しいという問題点があります。  
レプリケーションをするための方法としては、シングルリーダー、マルチリーダー、リーダーレスの3種類の方法があります。  
それぞれの詳細については下記で記載します。

# 詳細
- シングルリーダーレプリケーション  
一番シンプルなレプリケーションの方法となり、1つのリーダーに対して複数のフォロワーがいるモデルです。  
このモデルではクライアントは書き込みをリーダーに送り、リーダーはフォロワーに変更を伝えます。そして、フォロワーは読み取り専用となっています。  
シンプルでわかりやすい反面、リーダーが単一の障害点となり、書き込みの比重が大きい場合にはリーダーがボトルネックとなることもあります。  


- マルチリーダーレプリケーション
シングルリーダーレプリケーションに対して、複数のリーダーが存在するモデルです。  
複数のリーダーがいるためにリーダーが単一の障害点、ボトルネックになることはありません。  
その反面、複数の書き込みが同じデータに対して行われる可能性があるためデータの競合に対処を行う必要があり、一貫性を保つのが難しいです。  


- リーダーレスレプリケーション  
Cassandraなどで使用されているモデルとなっており、クライアントが書き込み、読み込み時に複数のマシンとやりとりを行います。  
書き込み時には指定された代数以上のマシンに保存が成功すると書き込み成功となります。(例：3台のマシンがあるとき、1台は障害でダウンしているが、その他の2台が保存できる状況）  
読み取り時には複数のマシンから読み取りを行うことでその中の新しいデータを判断します。（バージョン、タイムスタンプなどを書き込み時に一緒に保存する）


- レプリケーションのタイミング  
シングル・マルチリーダーの場合のフォロワー間レプリケーションのタイミングにはいくつかの種類があります。
同期、非同期、準同期の3種類です。  
同期はフォロワー内のデータがすべて最新化されるまで次の書き込みを待つ方法です。この方法はデータの一貫性は保たれますが、反映までの待ちが生じます。  
非同期は逆にすべてのフォロワーを待たないためフォロワー内の書き込みの遅延があっても、リーダーは書き込みを受け付けることができます。ただリーダーが障害時にフォロワーのデータが最新化されていないと書き込み途中のデータが失われてしまう可能性あります。  
一般的にはこの中間の方式として準同期が使われることが多いです。  
これはフォロワーのうち1つを同期として、他のフォロワーを非同期とする方針です。これによりリーダーの障害時にも同期的にデータが保存されているフォロワーは最新のデータを持っています。


- レプリケーションラグ時のアプリケーションの振る舞い  
レプリケーションを行う際にはリーダー、フォロワー間のデータのコピーの遅延などにより基本的に結果整合性（一貫性が一時的には保たれないが、最終的には同期などが行われて一貫性が保証される）の方針が取られます。  
その方針としては3種類あり、「read-after-write 一貫性」という自分の更新はリーダーから読み取ることで最新の値を取る方法。  
「モノトニックな読み取り」と呼ばれる、各ユーザーは常に同じレプリカから読み取る方法。「一貫性のあるプレフィックス読み取り」と呼ばれる依存関係のある書き込みを見る場合は順序を保持して見られるようにする方法があります。  
