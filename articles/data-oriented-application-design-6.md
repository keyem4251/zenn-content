---
title: "データ指向アプリケーションデザイン 2部 6章 まとめ"
emoji: "🚴🏽"
type: "idea"
topics: ["パーティショニング", "セカンダリインデックス", "memo"]
published: true
---
# はじめに
データ指向アプリケーションデザインを読んでいるので自分の理解のためにメモをまとめます。  
概要では全体に書いてあること、詳細では概要のそれぞれの要素についてを書きます。  
2部は5〜9章まであり、複数のノードにデータを分散させる手法のレプリケーション(5章)、パーティショニング(6章)についての説明、7章ではトランザクション、8、9章では分散システムの制約について記載します。

# 概要
パーティショニングはデータが膨大で１つのノードでは保存、処理をするのが困難な場合に負荷を分散するために使用します。  
パーティショニングの方法としてはキーを範囲で分割する方法、キーのハッシュ値で分割する方法があり、それぞれにメリット/デメリットがあります。  
また、今回は簡単のためデータをパーティショニングする場合にプライマリーキーで分割を行いますが、検索のためにセカンダリインデックスを作成する必要性も出てくるため、保存方法の種類についても紹介を行います。

# 詳細
- パーティショニングの方法
    - 範囲での分割  
  キーをソートしてパーティションごとに範囲を決めて分割を行います。ソートを行っているためキーが連続的に並んでおり、範囲検索が早いという特徴があります。  
  ただ、データの種類によっては特定のパーティションに検索の負荷がかかるホットスポットが生じやすいというデメリットもあります。
    - ハッシュ値での分割  
  キーをハッシュ値に変換して、パーティションに保存を行います。範囲での分割に対してデータが分散され保存されるためホットスポットが生じにくいですが、逆に範囲での検索に弱いという特徴があります。  
  実際には「ハッシュ値＋他のキー」を用いた複合キーでパーティションを行うことにより範囲検索に弱いというデメリットに対処を行う方法をCassandraなどでは取っています。
    - パーティションの数
  パーティションの数はサービスで固定サイズを見積もる、1つのパーティションで管理するデータの量に応じて分割、ノードあたりのパーティションの数を設定して自動でパーティションニングを行うなどの方法があります。


- セカンダリインデックスの方法
  - ドキュメントベース  
  各パーティションがそのパーティション内のデータだけをカバーするインデックスの作成の仕方、ローカルインデックスと呼ばれます。
  書き込みの際に該当の1つのパーティションだけですみますが、読み込みのときにすべてのパーティションを確認する必要があります。
  - 語ベース  
  すべてのパーティションをカバーするインデックスを作成する方法で、グローバルインデックスと呼ばれます。  
  セカンダリインデックス自体を1つのパーティションで管理するとボトルネックになるため、セカンダリインデックスもパーティションを行います。  
  読み取りが効率的に行われますが、書き込みが複数のパーティションになるため複雑になることがあります。
  実際にはDynamoDBなどではバックグラウンドで非同期で行われる用意になっています。


- ルーティングについて  
データの保存先が、ノードの追加/削除で変わることを管理するためにクライアントとノードの間にルーティング層を置き、Zookeeperなどのパーティションのメタデータなどルーティング先のを管理する仕組みを用いることでノードの変化に対応を行います
